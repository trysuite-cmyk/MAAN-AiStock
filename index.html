<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>Control de Stock</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50: '#f0f9ff',
                100: '#e0f2fe',
                500: '#0ea5e9',
                600: '#0284c7',
                900: '#0c4a6e',
              },
              ml: {
                yellow: '#ffe600',
                blue: '#2d3277'
              }
            }
          }
        }
      }
    </script>

    <!-- Babel para transformar JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Librería para escanear códigos QR/Barras -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
      body { background-color: #ffb600; -webkit-tap-highlight-color: transparent; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      
      #reader video {
        object-fit: cover;
        width: 100% !important;
        height: 100% !important;
        border-radius: 0.5rem;
      }
      
      /* Animación de pulso para el análisis de IA */
      @keyframes ai-pulse {
        0% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(147, 51, 234, 0); }
        100% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0); }
      }
      .ai-scanning {
        animation: ai-pulse 2s infinite;
      }
      
      /* Estilo para los chips de etiquetas */
      .tag-chip {
        animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      @keyframes popIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <!-- Lógica Principal de la Aplicación -->
    <script type="text/babel" data-presets="react" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { Scan, Plus, Search, Package, Sheet, ExternalLink, X, AlertCircle, Wand2, Save, Loader2, Camera, Image as ImageIcon, Sparkles, Cloud, CloudOff, RefreshCw, AlertTriangle, Minus, Trash2, Tag, Wifi, ArrowUp, ArrowDown, Zap, DollarSign, Calculator, Key, CheckCircle, ShoppingBag } from 'https://esm.sh/lucide-react@0.344.0';
        import { GoogleGenAI } from 'https://esm.sh/@google/genai';

        // --- CONFIGURACIÓN Y CONSTANTES ---
        const SHEETS_URL = "https://docs.google.com/spreadsheets/d/11X8ZnPzmpA-gDXyHNYDc5yyjm8ztSzzm4IJsAvgw-ho/edit?gid=0#gid=0";
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxRLjbztNWsxslJ1AJpMAQC-eYootzAxPGAh_fuNTgoT2fMfajNu6DIRoqdg9Y5HLY/exec"; 
        const STORAGE_KEY = 'inventario_data_v4';
        const API_KEY_STORAGE = 'gemini_api_key';
        
        // --- SERVICIOS ---
        
        // Helper para obtener la instancia de IA con la clave guardada
        const getAiInstance = () => {
            const key = localStorage.getItem(API_KEY_STORAGE);
            if (!key) throw new Error("Falta la API Key. Configúrala en el botón de llave.");
            return new GoogleGenAI({ apiKey: key });
        };

        // --- LÓGICA DE REINTENTOS PARA ERRORES 429 ---
        const callGeminiWithRetry = async (apiCallFn, maxRetries = 3) => {
            let retries = 0;
            let delay = 2000; // Iniciar con 2 segundos

            while (true) {
                try {
                    return await apiCallFn();
                } catch (error) {
                    const msg = error.toString().toLowerCase();
                    const isQuotaError = msg.includes("429") || msg.includes("resource_exhausted") || msg.includes("quota");
                    
                    if (isQuotaError && retries < maxRetries) {
                        console.warn(`⚠️ Cuota excedida (429). Reintentando en ${delay/1000}s... (Intento ${retries + 1}/${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff (2s, 4s, 8s)
                        retries++;
                    } else {
                        throw error;
                    }
                }
            }
        };

        // --- HELPER PARA MENSAJES DE ERROR LIMPIOS ---
        const formatGeminiError = (error) => {
            const raw = error.toString();
            // Identificar errores específicos de cuota
            if (raw.includes("429") || raw.includes("quota") || raw.includes("RESOURCE_EXHAUSTED")) {
                return "⚠️ Límite de Cuota Excedido (Error 429)\n\nEl servicio de IA gratuito de Google ha alcanzado su límite momentáneo. Por favor espera unos 30-60 segundos e intenta nuevamente.";
            }
            if (raw.includes("SAFETY")) {
                 return "⚠️ Contenido Bloqueado\n\nLa IA detectó contenido que podría violar las políticas de seguridad en la imagen o texto.";
            }
            // Intentar limpiar JSON crudo si aparece
            if (raw.includes('{"error":')) {
                try {
                    // Extraer parte JSON si está mezclada con texto
                    const jsonPart = raw.match(/\{.*\}/);
                    if (jsonPart) {
                        const parsed = JSON.parse(jsonPart[0]);
                        if (parsed.error && parsed.error.message) {
                            return "Error de IA: " + parsed.error.message;
                        }
                    }
                } catch(e) {}
            }
            // Limpieza genérica
            return "Error del Sistema: " + raw.replace('Error:', '').replace('GoogleGenAIError:', '').trim();
        };
        
        const syncItemToSheets = async (item, action = 'update') => {
            if (!APPS_SCRIPT_URL) return false;
            try {
                const safeItem = {
                    ...item,
                    stock: Number(item.stock), 
                    mlPrice: Number(item.mlPrice || 0), // Asegurar envío del precio
                    tags: Array.isArray(item.tags) ? item.tags : []
                };
                const payload = {
                    ...safeItem,
                    action: action, 
                    timestamp: new Date().toISOString()
                };
                console.log("Sincronizando:", payload);
                
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    keepalive: true,
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });
                return true;
            } catch (error) {
                console.error("Error subiendo a Sheets:", error);
                return false;
            }
        };

        const fetchInventoryFromCloud = async () => {
            if (!APPS_SCRIPT_URL) return null;
            try {
                const response = await fetch(APPS_SCRIPT_URL, { method: 'GET' });
                if (!response.ok) throw new Error("Error en red");
                const data = await response.json();
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.warn("No se pudo descargar desde la nube:", error);
                return null; 
            }
        };

        const getInventory = () => {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) { return []; }
        };

        const saveInventory = (items) => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
        };

        const getItemByBarcode = (barcode) => {
            const items = getInventory();
            return items.find(item => item.barcode === barcode);
        };

        const deleteItem = async (barcode) => {
            let items = getInventory();
            const itemToDelete = items.find(i => i.barcode === barcode);
            items = items.filter(item => item.barcode !== barcode);
            saveInventory(items);
            if (itemToDelete) {
                await syncItemToSheets(itemToDelete, 'delete');
            }
            return items;
        };

        const addOrUpdateItem = async (newItem) => {
            const items = getInventory();
            const index = items.findIndex(item => item.barcode === newItem.barcode);
            
            if (index !== -1) {
                items[index] = { 
                    ...items[index], 
                    ...newItem, 
                    stock: Number(newItem.stock),
                    mlPrice: Number(newItem.mlPrice || 0),
                    lastUpdated: new Date().toISOString() 
                };
                saveInventory(items);
                await syncItemToSheets(items[index], 'update');
            } else {
                const itemToSave = { 
                    ...newItem, 
                    stock: Number(newItem.stock),
                    mlPrice: Number(newItem.mlPrice || 0),
                    lastUpdated: new Date().toISOString() 
                };
                items.push(itemToSave);
                saveInventory(items);
                await syncItemToSheets(itemToSave, 'update');
            }
        };

        const processImage = async (file, maxWidth = 800, quality = 0.7) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        const base64 = dataUrl.split(',')[1];
                        resolve({ data: base64, mimeType: 'image/jpeg' });
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        const analyzeImageForProduct = async (file) => {
            return callGeminiWithRetry(async () => {
                try {
                    const ai = getAiInstance();
                    const { data, mimeType } = await processImage(file);
                    const prompt = `
                    Analiza esta imagen de producto (grifería, plomería, hogar).
                    Identifica el producto y extrae la mayor cantidad de información posible.
                    Si puedes leer el código de barras en la imagen, inclúyelo.
                    Responde estrictamente en formato JSON con la siguiente estructura:
                    {
                        "barcode": "código numérico o null",
                        "brand": "Marca visible o sugerida",
                        "model": "Modelo visible o descripción corta",
                        "color": "Color o acabado",
                        "location": "Ubicación sugerida (Cocina, Baño, etc.)",
                        "installType": "Tipo de instalación (Pared, Mesada, etc.)",
                        "details": "Descripción breve y características",
                        "tags": ["etiqueta1", "etiqueta2", "etiqueta3"]
                    }
                    `;
                    const schema = {
                        type: 'OBJECT',
                        properties: {
                            barcode: { type: 'STRING' },
                            brand: { type: 'STRING' },
                            model: { type: 'STRING' },
                            color: { type: 'STRING' },
                            location: { type: 'STRING' },
                            installType: { type: 'STRING' },
                            details: { type: 'STRING' },
                            tags: { type: 'ARRAY', items: { type: 'STRING' } }
                        }
                    };
                    const response = await ai.models.generateContent({
                        model: 'gemini-2.5-flash',
                        contents: {
                            parts: [
                                { inlineData: { mimeType: mimeType, data: data } },
                                { text: prompt }
                            ]
                        },
                        config: {
                            responseMimeType: "application/json",
                            responseSchema: schema
                        }
                    });
                    let text = response.text;
                    if (!text) return null;
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    return JSON.parse(text);
                } catch (error) {
                    console.error("Error analizando imagen con Gemini:", error);
                    throw error;
                }
            });
        };

        const suggestProductDetails = async (brand, model) => {
            return callGeminiWithRetry(async () => {
                try {
                    const ai = getAiInstance();
                    const prompt = `Actúa como experto en ferretería. Sugiere instalación, ubicación y etiquetas para: Marca "${brand}", Modelo "${model}". JSON: {installType, location, details, tags: []}`;
                    const response = await ai.models.generateContent({
                        model: 'gemini-2.5-flash',
                        contents: prompt,
                        config: { responseMimeType: "application/json" }
                    });
                    return JSON.parse(response.text);
                } catch (e) { 
                    console.error(e);
                    return null; 
                }
            });
        };

        const getMercadoLibrePrice = async (query) => {
            return callGeminiWithRetry(async () => {
                 try {
                    const ai = getAiInstance();
                    // Prompt ingeniería para evitar alucinaciones con cuotas o envíos
                    const prompt = `
                    Actúa como un asistente de compras experto en Argentina.
                    Objetivo: Encontrar el precio de mercado actual en Pesos Argentinos (ARS) para: "${query}".
                    
                    Instrucciones:
                    1. Usa Google Search para buscar este producto ESPECÍFICAMENTE en el sitio 'mercadolibre.com.ar'.
                    2. Busca el precio de un producto NUEVO. Ignora usados.
                    3. CRÍTICO: Debes distinguir el precio total del valor de las "cuotas". NO confundas "12x $5.000" con un precio de $5.000. El precio real sería aprox $60.000.
                    4. Ignora costos de envío.
                    5. Si hay varios resultados, descarta los muy baratos (repuestos/accesorios) y toma un promedio de los precios coherentes del producto principal.
                    6. Tu respuesta final debe ser SOLAMENTE un número entero representando el precio en ARS (sin puntos ni símbolos). Ejemplo: 154000.
                    Si no encuentras nada confiable, responde: 0.
                    `;

                    const response = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: prompt,
                        config: {
                            tools: [{ googleSearch: {} }]
                        }
                    });
                    
                    const text = response.text || "";
                    
                    // Limpieza agresiva para encontrar el número más probable
                    // Eliminamos posibles textos de cuotas "12x" o "6 cuotas" antes de buscar números
                    const cleanText = text.replace(/(\d+)\s*(x|cuotas)/gi, ''); 
                    
                    // Buscamos el primer número de al menos 3 dígitos (para evitar "12" cuotas, pero permitir precios bajos reales)
                    const match = cleanText.match(/(\d{3,})/); 
                    return match ? parseInt(match[0], 10) : 0;
                 } catch (e) {
                     console.error("Error buscando precio:", e);
                     throw e;
                 }
            });
        };

        // --- COMPONENTES ---

        const ErrorModal = ({ message, onClose }) => (
            <div className="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full max-h-[85vh] flex flex-col animate-in fade-in zoom-in duration-200">
                    <div className="flex flex-col items-center text-center">
                        <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4 shrink-0">
                            <AlertTriangle className="text-red-600" size={32} />
                        </div>
                        <h3 className="text-lg font-bold text-gray-900 mb-2 shrink-0">Atención</h3>
                        <div className="overflow-y-auto mb-6 w-full custom-scrollbar max-h-[40vh]">
                            <p className="text-gray-600 break-words text-sm leading-relaxed whitespace-pre-wrap">{message}</p>
                        </div>
                        <button onClick={onClose} className="bg-gray-900 text-white py-3 px-6 rounded-xl font-bold w-full hover:bg-gray-800 transition-colors shrink-0">
                            Entendido
                        </button>
                    </div>
                </div>
            </div>
        );

        const ScanConfirmationModal = ({ data, type, onConfirm, onCancel }) => {
            const isEntry = type === 'in';
            const existing = data.item;
            
            return (
                 <div className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center p-4 sm:p-0">
                     <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onCancel}></div>
                     <div className="relative bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-in slide-in-from-bottom duration-200">
                        <div className={`p-4 text-center ${isEntry ? 'bg-green-50' : 'bg-red-50'} border-b ${isEntry ? 'border-green-100' : 'border-red-100'}`}>
                            <h3 className={`text-lg font-bold ${isEntry ? 'text-green-700' : 'text-red-700'} flex items-center justify-center gap-2`}>
                                {isEntry ? <ArrowUp size={24} /> : <ArrowDown size={24} />}
                                {isEntry ? 'Confirmar Entrada' : 'Confirmar Salida'}
                            </h3>
                        </div>
                        <div className="p-6 text-center">
                            <div className="mb-4">
                                <p className="text-xs text-gray-400 font-mono mb-1">{data.code}</p>
                                <h2 className="text-xl font-bold text-gray-800 leading-tight">
                                    {existing ? `${existing.brand} ${existing.model}` : 'Producto Nuevo'}
                                </h2>
                                {existing && <p className="text-sm text-gray-500 mt-1">{existing.details || 'Sin descripción'}</p>}
                            </div>
                            
                            <div className="bg-gray-50 rounded-xl p-3 mb-6 inline-block border border-gray-100">
                                <span className="text-gray-500 text-xs uppercase font-bold mr-2">Stock Actual:</span>
                                <span className="text-xl font-bold text-gray-800">{existing ? existing.stock : 0}</span>
                                <span className="mx-2 text-gray-300">→</span>
                                <span className={`text-xl font-bold ${isEntry ? 'text-green-600' : 'text-red-600'}`}>
                                    {existing ? Math.max(0, parseInt(existing.stock || 0) + (isEntry ? 1 : -1)) : (isEntry ? 1 : 0)}
                                </span>
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={onCancel} className="py-3 px-4 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-bold transition-colors">
                                    Cancelar
                                </button>
                                <button onClick={onConfirm} className={`py-3 px-4 text-white rounded-xl font-bold shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2 ${isEntry ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}`}>
                                    <CheckCircle size={20} /> Confirmar
                                </button>
                            </div>
                        </div>
                     </div>
                 </div>
            );
        };

        const ApiKeyModal = ({ onClose }) => {
            const [key, setKey] = useState(localStorage.getItem(API_KEY_STORAGE) || '');
            
            const handleSave = () => {
                if(key.trim().length < 10) {
                    alert("Por favor ingresa una API Key válida.");
                    return;
                }
                localStorage.setItem(API_KEY_STORAGE, key.trim());
                onClose();
            };

            return (
                <div className="fixed inset-0 z-[70] bg-gray-900/90 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 relative animate-in fade-in zoom-in duration-200">
                         <div className="flex flex-col items-center mb-6">
                            <div className="w-14 h-14 bg-brand-100 text-brand-600 rounded-full flex items-center justify-center mb-3">
                                <Key size={28} />
                            </div>
                            <h2 className="text-xl font-bold text-gray-800">Configurar API Key</h2>
                            <p className="text-sm text-gray-500 text-center mt-1">
                                Ingresa tu clave de Google Gemini para habilitar las funciones de IA. Se guardará solo en tu dispositivo.
                            </p>
                         </div>
                         
                         <div className="space-y-4">
                             <div>
                                 <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">API Key</label>
                                 <input 
                                    type="text" 
                                    value={key} 
                                    onChange={(e) => setKey(e.target.value)} 
                                    className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none font-mono text-sm" 
                                    placeholder="AIzaSy..." 
                                 />
                             </div>
                             
                             <button onClick={handleSave} className="w-full bg-brand-600 text-white py-3 rounded-xl font-bold hover:bg-brand-700 transition-colors shadow-lg shadow-brand-500/30">
                                 Guardar Configuración
                             </button>
                             <div className="text-center">
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-xs text-brand-600 hover:underline">
                                    Conseguir API Key gratis en Google AI Studio
                                </a>
                             </div>
                         </div>
                    </div>
                </div>
            );
        };

        const ValuationModal = ({ items, onClose }) => {
            const totalStock = items.reduce((sum, item) => sum + (Number(item.stock) || 0), 0);
            const totalValue = items.reduce((sum, item) => sum + ((Number(item.stock) || 0) * (Number(item.mlPrice) || 0)), 0);
            const itemsWithPrice = items.filter(i => i.mlPrice > 0).length;
            
            // Formateador de moneda para Argentina
            const fmt = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 });

            return (
                <div className="fixed inset-0 z-50 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden flex flex-col animate-in fade-in zoom-in duration-200">
                         <div className="bg-gradient-to-r from-emerald-600 to-emerald-800 p-6 text-white text-center">
                             <div className="mx-auto bg-white/20 w-16 h-16 rounded-full flex items-center justify-center mb-3 backdrop-blur-sm">
                                <DollarSign size={32} className="text-white" />
                             </div>
                             <h2 className="text-2xl font-bold">Valorización de Stock</h2>
                             <p className="text-emerald-100 text-sm">Estimación basada en MercadoLibre</p>
                         </div>
                         
                         <div className="p-6 space-y-6">
                            <div className="text-center">
                                <p className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-1">VALOR TOTAL ESTIMADO</p>
                                <p className="text-4xl font-black text-gray-800 tracking-tight">{fmt.format(totalValue)}</p>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 text-center">
                                    <p className="text-gray-500 text-xs font-bold uppercase">Unidades</p>
                                    <p className="text-xl font-bold text-gray-800">{totalStock}</p>
                                </div>
                                <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 text-center">
                                    <p className="text-gray-500 text-xs font-bold uppercase">Prod. con Precio</p>
                                    <p className="text-xl font-bold text-gray-800">{itemsWithPrice} <span className="text-gray-400 text-sm">/ {items.length}</span></p>
                                </div>
                            </div>

                            <p className="text-xs text-gray-400 text-center italic leading-relaxed">
                                * Los precios son referencias automáticas obtenidas de MercadoLibre y pueden variar.
                            </p>
                         </div>

                         <div className="p-4 bg-gray-50 border-t">
                             <button onClick={onClose} className="w-full bg-white border border-gray-300 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-100 transition-colors">
                                 Cerrar
                             </button>
                         </div>
                    </div>
                </div>
            );
        };

        const SelectionModal = ({ mode, onScan, onPhoto, onClose }) => {
            const isOut = mode === 'out';
            const colorClass = isOut ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700';
            const title = isOut ? 'Retirar Stock' : 'Ingresar Stock';

            return (
                <div className="fixed inset-0 z-50 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 relative">
                         <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><X size={24} /></button>
                         <h2 className={`text-xl font-bold text-center mb-6 ${isOut ? 'text-red-600' : 'text-green-600'}`}>{title}</h2>
                         <div className="space-y-4">
                            <button onClick={onScan} className="w-full p-4 rounded-xl border border-gray-200 hover:border-brand-500 hover:bg-gray-50 flex items-center gap-4 transition-all group">
                                <div className={`w-12 h-12 rounded-full ${colorClass} flex items-center justify-center group-hover:scale-110 transition-transform`}>
                                    <Scan size={24} />
                                </div>
                                <div className="text-left">
                                    <p className="font-bold text-gray-800">Escanear Código</p>
                                    <p className="text-xs text-gray-500">Usar lector de barras/QR</p>
                                </div>
                            </button>
                            <button onClick={onPhoto} className="w-full p-4 rounded-xl border border-gray-200 hover:border-brand-500 hover:bg-gray-50 flex items-center gap-4 transition-all group">
                                <div className={`w-12 h-12 rounded-full ${colorClass} flex items-center justify-center group-hover:scale-110 transition-transform`}>
                                    <Sparkles size={24} />
                                </div>
                                <div className="text-left">
                                    <p className="font-bold text-gray-800">Analizar Foto (IA)</p>
                                    <p className="text-xs text-gray-500">Cámara o Galería</p>
                                </div>
                            </button>
                         </div>
                    </div>
                </div>
            );
        };

        const Scanner = ({ onScanSuccess, onClose, mode }) => {
            const [permissionError, setPermissionError] = useState(null);
            const [cameraReady, setCameraReady] = useState(false);
            const [useLocalFile, setUseLocalFile] = useState(false);
            const scannerRef = useRef(null);
            const fileInputRef = useRef(null);

            const borderColor = mode === 'out' ? 'border-red-500 shadow-[0_0_10px_red]' : (mode === 'in' ? 'border-green-500 shadow-[0_0_10px_lime]' : 'border-brand-500 shadow-[0_0_10px_cyan]');
            const modeText = mode === 'out' ? 'MODO SALIDA RÁPIDA (-1)' : (mode === 'in' ? 'MODO ENTRADA RÁPIDA (+1)' : 'MODO CONSULTA');

            useEffect(() => {
                let html5QrCode;
                let isMounted = true;
                const protocol = window.location.protocol;
                const isFileOrContent = protocol === 'file:' || protocol === 'content:';
                
                if (isFileOrContent) {
                    setUseLocalFile(true); 
                    setPermissionError("MODO LOCAL: La cámara no funciona en archivos locales (file://).");
                    return;
                }

                const startCamera = async () => {
                    await new Promise(r => setTimeout(r, 400));
                    if (!document.getElementById("reader")) return;
                    try {
                        html5QrCode = new Html5Qrcode("reader");
                        scannerRef.current = html5QrCode;
                        const qrBoxSize = Math.min(window.innerWidth * 0.7, 300);
                        await html5QrCode.start(
                            { facingMode: "environment" }, 
                            { fps: 15, qrbox: { width: qrBoxSize, height: qrBoxSize }, aspectRatio: window.innerHeight / window.innerWidth, disableFlip: false },
                            (decodedText) => { if (isMounted) { onScanSuccess(decodedText); } },
                            () => {}
                        );
                        if (isMounted) setCameraReady(true);
                    } catch (err) {
                        if (isMounted) setPermissionError("No se pudo acceder a la cámara. Verifica los permisos o usa el modo 'Foto'.");
                    }
                };
                startCamera();
                return () => { isMounted = false; if (scannerRef.current?.isScanning) scannerRef.current.stop().catch(console.error); };
            }, [onScanSuccess]);

            return (
                <div className="fixed inset-0 z-50 bg-black flex flex-col">
                    <div className="flex justify-between items-center p-4 bg-gray-900 text-white z-10">
                        <h2 className="font-semibold text-lg flex items-center gap-2"><Scan className="text-brand-500" /> Escáner</h2>
                        <button onClick={onClose} className="p-2 bg-gray-800 rounded-full"><X size={20} /></button>
                    </div>
                    <div className="relative flex-1 bg-black flex flex-col items-center justify-center p-4">
                         {permissionError ? (
                            <div className="text-center text-white px-6">
                                <AlertTriangle className="mx-auto text-yellow-500 mb-4" size={48} />
                                <p className="mb-6">{permissionError}</p>
                                <button onClick={() => fileInputRef.current?.click()} className="bg-brand-600 text-white py-3 px-6 rounded-xl font-bold flex items-center gap-2 mx-auto">
                                    <Camera size={20} /> Usar Foto
                                </button>
                            </div>
                         ) : (
                            <div className="w-full h-full relative rounded-2xl overflow-hidden bg-gray-900">
                                <div id="reader" className="w-full h-full"></div>
                                {cameraReady && (
                                    <>
                                        <div className={`absolute inset-0 pointer-events-none border-[50px] border-black/50 flex items-center justify-center`}>
                                            <div className={`w-full h-[2px] ${borderColor}`}></div>
                                        </div>
                                        <div className="absolute bottom-10 left-0 right-0 text-center pointer-events-none">
                                            <span className="bg-black/60 text-white px-4 py-2 rounded-full text-sm font-bold backdrop-blur-sm">{modeText}</span>
                                        </div>
                                    </>
                                )}
                            </div>
                         )}
                         <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={(e) => { if(e.target.files[0]) { /* Logica externa */ } }} />
                    </div>
                </div>
            );
        };

        const ProductForm = ({ initialData, existingItem, onSave, onDelete, onCancel, mode, onError }) => {
            const [barcode, setBarcode] = useState(initialData?.barcode || '');
            const [brand, setBrand] = useState(existingItem?.brand || initialData?.brand || '');
            const [model, setModel] = useState(existingItem?.model || initialData?.model || '');
            const [color, setColor] = useState(existingItem?.color || initialData?.color || '');
            const [location, setLocation] = useState(existingItem?.location || initialData?.location || '');
            const [installType, setInstallType] = useState(existingItem?.installType || initialData?.installType || '');
            const [details, setDetails] = useState(existingItem?.details || initialData?.details || '');
            const [tags, setTags] = useState(existingItem?.tags || initialData?.tags || []);
            // Se inicializa como string vacío si es 0 para facilitar la edición
            const [mlPrice, setMlPrice] = useState(existingItem?.mlPrice ? existingItem.mlPrice : '');
            const [currentTag, setCurrentTag] = useState('');
            const [stock, setStock] = useState(existingItem?.stock || 0);
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [isPriceLoading, setIsPriceLoading] = useState(false);
            const [isSaving, setIsSaving] = useState(false);

            const formTitle = (brand && model) ? `${brand} ${model}` : (existingItem ? 'Producto Sin Nombre' : 'Nuevo Producto');

            const handleAiSuggest = async () => {
                if (!brand || !model) return;
                setIsAiLoading(true);
                const suggestion = await suggestProductDetails(brand, model);
                setIsAiLoading(false);
                if (suggestion) {
                    setInstallType(suggestion.installType || installType);
                    setLocation(suggestion.location || location);
                    setDetails(suggestion.details || details);
                    if (suggestion.tags && Array.isArray(suggestion.tags)) {
                        setTags([...new Set([...tags, ...suggestion.tags])]);
                    }
                }
            };

            const handlePriceCheck = async () => {
                 const queryParts = [];
                 // Prioridad a Marca y Modelo
                 if (brand) queryParts.push(brand);
                 if (model) queryParts.push(model);
                 
                 // Detalles importantes para ferretería/hogar
                 if (installType) queryParts.push(installType);
                 if (location) queryParts.push(location);
                 if (color) queryParts.push(color);

                 // Detalles adicionales con limite mayor
                 if (details && details.length < 60) queryParts.push(details);

                 // Si tenemos poco texto, agregamos el código de barras
                 if (queryParts.length < 3 && barcode) {
                    queryParts.push(barcode);
                 }

                 if (queryParts.length === 0) {
                     onError("Ingresa al menos una Marca y Modelo para buscar el precio.");
                     return;
                 }

                 const query = queryParts.join(" ");
                 setIsPriceLoading(true);
                 try {
                     const price = await getMercadoLibrePrice(query);
                     if (price && price > 0) {
                         setMlPrice(price);
                     } else {
                         onError("No se pudo encontrar un precio automático. Verifica los datos o intenta ser más específico en el Modelo.");
                     }
                 } catch (e) {
                     onError(formatGeminiError(e));
                 } finally {
                     setIsPriceLoading(false);
                 }
            };

            const handleTagKeyDown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const val = currentTag.trim();
                    if (val && !tags.includes(val)) {
                        setTags([...tags, val]);
                        setCurrentTag('');
                    }
                }
            };

            const removeTag = (tagToRemove) => { setTags(tags.filter(t => t !== tagToRemove)); };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                await onSave({
                    id: barcode, barcode, brand, model, color, location, installType, stock: Number(stock), details, tags, mlPrice: Number(mlPrice),
                    lastUpdated: new Date().toISOString()
                });
                setIsSaving(false);
            };

            const handleDelete = async () => {
                if(confirm("¿Eliminar producto?")) { await onDelete(barcode); }
            };

            // Valor total de este item
            const itemTotalValue = (Number(stock) || 0) * (Number(mlPrice) || 0);

            return (
                <div className="fixed inset-0 z-40 bg-gray-900/50 backdrop-blur-sm flex justify-center items-end sm:items-center p-0 sm:p-4">
                    <div className="bg-white w-full max-w-lg rounded-t-2xl sm:rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                            <div>
                                <h2 className="text-xl font-bold text-gray-800">{formTitle}</h2>
                                <p className="text-xs text-gray-500 font-mono mt-0.5">{barcode}</p>
                            </div>
                            <button onClick={onCancel} className="text-gray-500 hover:bg-gray-200 p-2 rounded-full"><X size={24} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto flex-1 space-y-5">
                            <div className={`p-4 rounded-xl border-2 ${mode === 'out' ? 'bg-red-50 border-red-100' : 'bg-green-50 border-green-100'} mb-4`}>
                                <label className="block text-center text-sm font-bold uppercase tracking-wider mb-2 text-gray-600">
                                    {mode === 'out' ? 'Retirar Stock' : (mode === 'in' ? 'Ingresar Stock' : 'Gestionar Stock')}
                                </label>
                                <div className="flex items-center justify-center gap-4">
                                    <button type="button" onClick={() => setStock(s => Math.max(0, s-1))} className="w-12 h-12 bg-white rounded-full shadow-sm border border-gray-200 flex items-center justify-center hover:bg-gray-50 active:scale-95 transition-all text-gray-700"><Minus size={24}/></button>
                                    <div className="flex flex-col items-center">
                                        <input type="number" value={stock} onChange={(e) => setStock(Number(e.target.value))} className="w-24 text-center text-4xl font-bold bg-transparent outline-none text-gray-900" />
                                        <span className="text-xs text-gray-400 font-medium uppercase">Unidades</span>
                                    </div>
                                    <button type="button" onClick={() => setStock(s => s+1)} className="w-12 h-12 bg-white rounded-full shadow-sm border border-gray-200 flex items-center justify-center hover:bg-gray-50 active:scale-95 transition-all text-gray-700"><Plus size={24}/></button>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Código de Barras</label>
                                <input type="text" value={barcode} onChange={(e) => setBarcode(e.target.value)} className="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 font-mono text-gray-700 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Escanea o escribe..." />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Marca</label>
                                    <input type="text" value={brand} onChange={(e) => setBrand(e.target.value)} className="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Ej. FV" required />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Modelo</label>
                                    <input type="text" value={model} onChange={(e) => setModel(e.target.value)} className="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Ej. Arizona" required />
                                </div>
                            </div>

                            <div className="flex justify-end">
                                <button type="button" onClick={handleAiSuggest} disabled={isAiLoading || !brand || !model} className="flex items-center gap-2 text-xs font-medium text-brand-600 hover:text-brand-800 transition-colors">
                                    {isAiLoading ? <Loader2 className="animate-spin" size={12} /> : <Wand2 size={12} />} Autocompletar con IA
                                </button>
                            </div>
                            
                            {/* SECCION PRECIO ML */}
                            <div className="bg-white border-2 border-ml-yellow/30 rounded-xl p-3 shadow-sm">
                                <label className="block text-xs font-bold text-ml-blue uppercase tracking-wider mb-1">Precio Referencia (MercadoLibre)</label>
                                <div className="flex gap-2">
                                    <div className="relative flex-1">
                                        <div className="absolute left-3 top-1/2 -translate-y-1/2 text-ml-blue font-bold">$</div>
                                        <input 
                                            type="number" 
                                            value={mlPrice} 
                                            onChange={(e) => setMlPrice(e.target.value === '' ? '' : Number(e.target.value))} 
                                            className="w-full pl-6 pr-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-ml-yellow outline-none bg-white text-gray-900 font-bold" 
                                            placeholder="0" 
                                        />
                                    </div>
                                    <button 
                                        type="button" 
                                        onClick={handlePriceCheck} 
                                        disabled={isPriceLoading} 
                                        className="bg-ml-yellow text-ml-blue px-4 py-2 rounded-lg hover:brightness-95 transition-all flex items-center gap-2 font-bold shadow-sm disabled:opacity-70 disabled:cursor-not-allowed"
                                        style={{ backgroundColor: '#ffe600', color: '#2d3277' }}
                                    >
                                        {isPriceLoading ? <Loader2 className="animate-spin" size={18} /> : <Search size={18} />}
                                        <span className="hidden sm:inline">Buscar Precio</span>
                                    </button>
                                </div>
                                <div className="mt-2 text-right text-xs font-bold text-gray-500">
                                    Valor Total: ${new Intl.NumberFormat('es-AR').format(itemTotalValue)}
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Etiquetas</label>
                                <div className="p-2 border border-gray-200 rounded-xl bg-white focus-within:ring-2 focus-within:ring-brand-500 transition-all flex flex-wrap gap-2 min-h-[50px]">
                                    {tags.map(tag => (
                                        <span key={tag} className="tag-chip bg-brand-50 text-brand-700 px-3 py-1 rounded-full text-sm font-medium flex items-center gap-1">
                                            {tag}
                                            <button onClick={() => removeTag(tag)} className="hover:text-brand-900 rounded-full p-0.5"><X size={14}/></button>
                                        </span>
                                    ))}
                                    <input type="text" value={currentTag} onChange={(e) => setCurrentTag(e.target.value)} onKeyDown={handleTagKeyDown} className="flex-1 min-w-[100px] outline-none bg-transparent py-1" placeholder={tags.length === 0 ? "Escribe y Enter..." : ""} />
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Ubicación</label>
                                    <input type="text" value={location} onChange={(e) => setLocation(e.target.value)} className="w-full p-3 border border-gray-200 rounded-xl" placeholder="Ej. Cocina" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Tipo Instalación</label>
                                    <input type="text" value={installType} onChange={(e) => setInstallType(e.target.value)} className="w-full p-3 border border-gray-200 rounded-xl" placeholder="Ej. Pared" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Detalles</label>
                                <textarea value={details} onChange={(e) => setDetails(e.target.value)} rows={2} className="w-full p-3 border border-gray-200 rounded-xl resize-none" placeholder="Características..."></textarea>
                            </div>
                        </div>
                        <div className="p-4 border-t bg-gray-50 rounded-b-2xl flex flex-col gap-3">
                            <button onClick={handleSubmit} disabled={isSaving} className={`w-full text-white py-4 px-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 disabled:opacity-70 ${mode === 'out' ? 'bg-red-600 hover:bg-red-700' : 'bg-brand-600 hover:bg-brand-700'}`}>
                                {isSaving ? <Loader2 className="animate-spin" size={20} /> : <Save size={20} />} 
                                {isSaving ? 'Guardando...' : 'Confirmar Cambios'}
                            </button>
                            {existingItem && (
                                <button onClick={handleDelete} className="w-full bg-white text-red-500 py-3 px-4 rounded-xl font-medium border border-red-100 hover:bg-red-50 flex items-center justify-center gap-2"><Trash2 size={18} /> Eliminar Producto</button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [viewMode, setViewMode] = useState('list');
            const [actionMode, setActionMode] = useState('view');
            const [showActionModal, setShowActionModal] = useState(false);
            const [showValuationModal, setShowValuationModal] = useState(false);
            const [showApiKeyModal, setShowApiKeyModal] = useState(false);
            const [scanConfirmation, setScanConfirmation] = useState(null); // Nuevo estado para confirmación
            const [items, setItems] = useState([]);
            const [scannedData, setScannedData] = useState(null);
            const [editingItem, setEditingItem] = useState(undefined);
            const [searchQuery, setSearchQuery] = useState('');
            const [toast, setToast] = useState(null);
            const [errorMessage, setErrorMessage] = useState(null); 
            const [isAnalyzingPhoto, setIsAnalyzingPhoto] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            
            const lastScanRef = useRef(0);
            const scanLockRef = useRef(false);
            const photoInputRef = useRef(null);

            useEffect(() => {
                const localData = getInventory();
                setItems(localData);

                // Verificar si existe API Key
                const existingKey = localStorage.getItem(API_KEY_STORAGE);
                if (!existingKey) {
                    setShowApiKeyModal(true);
                }

                const autoSync = async () => {
                    if (APPS_SCRIPT_URL) {
                        setIsSyncing(true);
                        try {
                            const cloudData = await fetchInventoryFromCloud();
                            if (cloudData && Array.isArray(cloudData)) {
                                saveInventory(cloudData);
                                setItems(cloudData);
                            }
                        } catch (e) { console.error(e); } finally {
                            setIsSyncing(false);
                        }
                    }
                };
                autoSync();
            }, []);

            const showToast = (msg, type = 'success') => {
                setToast({ msg, type });
                setTimeout(() => setToast(null), 3000);
            };

            const handleCloudRefresh = async () => {
                setIsSyncing(true);
                showToast("Sincronizando...", "info");
                const cloudData = await fetchInventoryFromCloud();
                if (cloudData) {
                    saveInventory(cloudData);
                    setItems(cloudData);
                    showToast("Actualizado", "success");
                } else {
                    showToast("Error de conexión.", "error");
                }
                setIsSyncing(false);
            };

            const openSelectionModal = (mode) => {
                setActionMode(mode);
                setShowActionModal(true);
            };

            const triggerScanner = () => {
                setShowActionModal(false);
                setViewMode('scanner');
                scanLockRef.current = false;
                lastScanRef.current = 0;
            };

            const triggerPhoto = () => {
                setShowActionModal(false);
                photoInputRef.current?.click();
            };

            const handleScanSuccess = async (code) => {
                const now = Date.now();
                if (scanLockRef.current || (now - lastScanRef.current < 2000)) return;
                
                lastScanRef.current = now;
                scanLockRef.current = true;
                
                if (navigator.vibrate) navigator.vibrate(100);

                const existing = getItemByBarcode(code);
                
                if ((actionMode === 'in' || actionMode === 'out')) {
                    // Lógica Modificada: En vez de actuar directo, pedimos confirmación
                    setScanConfirmation({ code, item: existing, type: actionMode });
                    // No desbloqueamos el escáner todavía para evitar lecturas múltiples de fondo
                    return; 
                }

                setViewMode('list'); 
                
                if (actionMode === 'out' && !existing) {
                    showToast("Producto no encontrado en inventario", "error");
                    scanLockRef.current = false;
                    return;
                }

                setScannedData({ barcode: code });
                setEditingItem(existing); 
                setViewMode('form');
                
                if (existing) showToast(`Producto encontrado: ${existing.brand}`, 'info');
                else showToast('Nuevo producto detectado', 'info');
                
                scanLockRef.current = false;
            };

            const handleConfirmScan = async () => {
                if (!scanConfirmation) return;

                const { code, item: existing, type } = scanConfirmation;
                
                if (!existing) {
                    // Si no existe y estamos en modo confirmar, debería ser IN (porque OUT bloquea antes si no existe, 
                    // salvo que sea una lógica futura, pero asumimos IN crea nuevo).
                    // Para simplificar, si no existe en IN/OUT rápido, redirigimos al formulario para crearlo.
                     setViewMode('list');
                     setScannedData({ barcode: code });
                     setEditingItem(undefined);
                     setViewMode('form');
                     showToast("Producto nuevo. Complete los datos.", "info");
                     setScanConfirmation(null);
                     scanLockRef.current = false;
                     return;
                }

                const change = type === 'in' ? 1 : -1;
                const currentStock = parseInt(existing.stock || 0, 10);
                const newStock = Math.max(0, currentStock + change);
                
                if (currentStock === 0 && change === -1) {
                    showToast(`El stock ya es 0 para ${existing.brand}`, 'error');
                } else {
                    const updatedItem = { 
                        ...existing, 
                        stock: newStock, 
                        lastUpdated: new Date().toISOString() 
                    };

                    await addOrUpdateItem(updatedItem);
                    setItems(getInventory()); 

                    const typeText = type === 'in' ? 'ENTRADA' : 'SALIDA';
                    showToast(`${typeText}: ${existing.brand} ${existing.model} (Stock: ${newStock})`, type === 'in' ? 'success' : 'error');
                }
                
                setScanConfirmation(null);
                // Pequeño delay para que el usuario quite el producto del frente de la cámara
                setTimeout(() => { scanLockRef.current = false; }, 1000);
            };

            const handleCancelScan = () => {
                setScanConfirmation(null);
                setTimeout(() => { scanLockRef.current = false; }, 500);
            };

            const handlePhotoUpload = async (e) => {
                if (e.target.files.length === 0) return;
                const imageFile = e.target.files[0];
                setIsAnalyzingPhoto(true);
                try {
                    const aiData = await analyzeImageForProduct(imageFile);
                    if (aiData) {
                        const finalBarcode = aiData.barcode || `AUTO-${Date.now().toString().slice(-6)}`;
                        const existing = getItemByBarcode(finalBarcode);

                        if (actionMode === 'out' && !existing) {
                            showToast("Producto no encontrado. No se puede retirar.", "error");
                            setIsAnalyzingPhoto(false);
                            return;
                        }

                        setScannedData({ ...aiData, barcode: finalBarcode });
                        setEditingItem(existing);
                        setViewMode('form');
                        showToast(existing ? "Producto identificado" : "Nuevo producto detectado", "success");
                    } else { showToast("No se pudo identificar el producto", "error"); }
                } catch (error) {
                    setErrorMessage(formatGeminiError(error));
                } finally {
                    setIsAnalyzingPhoto(false);
                    if (photoInputRef.current) photoInputRef.current.value = '';
                }
            };

            const handleSaveItem = async (item) => {
                await addOrUpdateItem(item);
                setItems(getInventory());
                setViewMode('list');
                setEditingItem(undefined);
                setScannedData(null);
                showToast('Cambios guardados', 'success');
            };

            const handleDeleteItem = async (barcode) => {
                const newItems = await deleteItem(barcode);
                setItems(newItems);
                setViewMode('list');
                showToast('Producto eliminado', 'success');
            };

            const openProductDetail = (item) => {
                setActionMode('view'); 
                setScannedData({ barcode: item.barcode });
                setEditingItem(item);
                setViewMode('form');
            };

            const filteredItems = items.filter(i => {
                const q = searchQuery.toLowerCase();
                const inTags = i.tags && Array.isArray(i.tags) && i.tags.some(t => t.toLowerCase().includes(q));
                return (
                    (i.brand || '').toLowerCase().includes(q) || 
                    (i.model || '').toLowerCase().includes(q) ||
                    (i.barcode || '').includes(q) ||
                    (i.location || '').toLowerCase().includes(q) ||
                    inTags
                );
            });

            return (
                <div className="min-h-screen bg-[#ffb600] font-sans text-gray-900 pb-20">
                    <header className="bg-white sticky top-0 z-30 shadow-sm border-b border-gray-100">
                        <div className="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-2 cursor-pointer" onClick={() => setViewMode('list')}>
                                <div className="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white shadow-brand-500/30 shadow-lg"><Package size={20} /></div>
                                <h1 className="text-xl font-bold tracking-tight text-gray-800">Control de Stock</h1>
                            </div>
                            <div className="flex gap-2 items-center">
                                <button onClick={() => setShowApiKeyModal(true)} className="p-2 text-brand-600 bg-brand-50 rounded-full hover:bg-brand-100 transition-colors">
                                    <Key size={20} />
                                </button>
                                <button onClick={() => setShowValuationModal(true)} className="p-2 text-emerald-600 bg-emerald-50 rounded-full hover:bg-emerald-100 transition-colors">
                                    <DollarSign size={20} />
                                </button>
                                <button onClick={handleCloudRefresh} disabled={isSyncing} className={`p-2 rounded-full text-gray-500 hover:bg-gray-100 transition-all ${isSyncing ? 'animate-spin' : ''}`}>
                                    <RefreshCw size={20} />
                                </button>
                                <a href={SHEETS_URL} target="_blank" rel="noopener noreferrer" className="p-2 text-green-600 bg-green-50 rounded-full hover:bg-green-100 transition-colors"><Sheet size={20} /></a>
                            </div>
                        </div>
                    </header>
                    <main>
                        {viewMode === 'list' && (
                            <div className="pt-6 max-w-4xl mx-auto px-4">
                                <div className="relative mb-6">
                                    <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                                    <input type="text" placeholder="Buscar producto..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full pl-12 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none shadow-sm" />
                                </div>
                                {filteredItems.length === 0 ? (
                                    <div className="text-center py-20 text-white"><Package size={48} className="mx-auto mb-4 opacity-50" /><p className="font-medium">No se encontraron productos.</p></div>
                                ) : (
                                    <div className="space-y-3 pb-24">
                                        {filteredItems.map(item => (
                                            <div key={item.barcode} onClick={() => openProductDetail(item)} className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-all cursor-pointer relative group flex gap-4 items-center">
                                                <div className="w-12 h-12 rounded-xl bg-brand-50 text-brand-600 flex items-center justify-center shrink-0"><Package size={24} /></div>
                                                <div className="flex-1 min-w-0">
                                                    <h4 className="font-bold text-gray-900 truncate text-lg">{item.brand} {item.model}</h4>
                                                    <p className="text-xs text-gray-500 font-mono truncate">{item.barcode}</p>
                                                    <div className="flex flex-wrap gap-1 mt-1">
                                                        {item.tags && item.tags.slice(0, 3).map(t => (<span key={t} className="text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">{t}</span>))}
                                                    </div>
                                                </div>
                                                <div className="text-center px-2 flex flex-col items-end">
                                                    <span className="block text-2xl font-bold text-gray-800">{item.stock}</span>
                                                    <span className="text-[10px] text-gray-400 uppercase font-bold">Stock</span>
                                                    {item.mlPrice > 0 && <span className="text-[10px] text-emerald-600 font-bold bg-emerald-50 px-1 rounded mt-1">${item.mlPrice}</span>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <div className="fixed bottom-6 right-6 flex flex-col gap-4 z-30">
                                    <button onClick={() => openSelectionModal('in')} className="w-16 h-16 bg-green-600 text-white rounded-full shadow-xl shadow-green-600/30 flex items-center justify-center hover:bg-green-700 active:scale-95 transition-all"><ArrowUp size={32} /></button>
                                    <button onClick={() => openSelectionModal('out')} className="w-16 h-16 bg-red-600 text-white rounded-full shadow-xl shadow-red-600/30 flex items-center justify-center hover:bg-red-700 active:scale-95 transition-all"><ArrowDown size={32} /></button>
                                </div>
                            </div>
                        )}
                    </main>
                    {isAnalyzingPhoto && (
                        <div className="fixed inset-0 z-50 bg-black/80 flex flex-col items-center justify-center text-white backdrop-blur-md">
                            <div className="relative"><Sparkles size={64} className="text-purple-400 animate-pulse" /><div className="absolute inset-0 bg-purple-500/20 blur-xl rounded-full animate-ping"></div></div>
                            <p className="text-2xl font-bold mt-6">Analizando Imagen</p>
                            <p className="text-gray-400 mt-2 text-center max-w-xs">Procesando...</p>
                        </div>
                    )}
                    <input type="file" ref={photoInputRef} className="hidden" accept="image/*" capture="environment" onChange={handlePhotoUpload} />
                    {errorMessage && <ErrorModal message={errorMessage} onClose={() => setErrorMessage(null)} />}
                    {showActionModal && <SelectionModal mode={actionMode} onScan={triggerScanner} onPhoto={triggerPhoto} onClose={() => setShowActionModal(false)} />}
                    {showValuationModal && <ValuationModal items={items} onClose={() => setShowValuationModal(false)} />}
                    {showApiKeyModal && <ApiKeyModal onClose={() => setShowApiKeyModal(false)} />}
                    {scanConfirmation && <ScanConfirmationModal data={scanConfirmation} type={scanConfirmation.type} onConfirm={handleConfirmScan} onCancel={handleCancelScan} />}
                    {viewMode === 'scanner' && <Scanner onScanSuccess={handleScanSuccess} onClose={() => setViewMode('list')} mode={actionMode} />}
                    {viewMode === 'form' && <ProductForm initialData={scannedData} existingItem={editingItem} onSave={handleSaveItem} onDelete={handleDeleteItem} onCancel={() => setViewMode('list')} mode={actionMode} onError={(msg) => setErrorMessage(msg)} />}
                    {toast && <div className={`fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-2xl shadow-2xl text-white font-medium text-sm transition-all animate-bounce z-50 flex items-center gap-2 max-w-[90vw] text-center ${toast.type === 'error' ? 'bg-red-500' : 'bg-gray-900'}`}>{toast.type === 'success' && <div className="w-2 h-2 rounded-full bg-green-400 shrink-0"></div>}{toast.msg}</div>}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
